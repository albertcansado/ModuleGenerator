/* KeyValue Version: 1.2 Albert Cansado Sola @albertcansado */
var KeyValue=function(){"use strict";var a={table:null,btn:null,inputLabel:null,inputValue:null,hiddenInput:null,checkTitle:null,saveOrder:null,empty:!0,emptyText:"No items to display",edit:{editing:!1,deleted:!1,row:null,beforeInput1:"",beforeInput2:""},formatText:"%s1:%s2:%s3",separator:";",formatId:"kv%s1",nextId:1,inputs:{name:"m1_",checkboxName:"multiselect[]"},lang:{edit:"Edit",saveRow:"SaveRow","delete":"Delete"},icons:{deleteIcon:"themes/OneEleven/images/icons/system/delete.gif",editIcon:"themes/OneEleven/images/icons/system/edit.gif",cancelIcon:"themes/OneEleven/images/icons/extra/false.gif",saveIcon:"themes/OneEleven/images/icons/extra/green.gif"},rowClass:{odd:"row1",even:"row2",actual:"odd"}},b={extend:function(a){if(!this.isObject(a))return a;for(var b,c,d=1,e=arguments.length;e>d;d++){b=arguments[d];for(c in b)a[c]=b[c]}return a},insert:function(a,b){return a.innerHTML="",this.isElement(b)?a.appendChild(b):a.innerHTML=b.toString(),a},getValue:function(a){return a&&"input"===a.tagName.toLowerCase()?a.value.toString().trim():""},setValue:function(a,b){return a&&"input"===a.tagName.toLowerCase()?(a.value=b,a):""},isUndefined:function(a){return"undefined"==typeof a},isNull:function(a){return Boolean(null===a)},isEmpty:function(a){return!a||0===a.length},isElement:function(a){return a instanceof Element},isBoolean:function(a){return"boolean"==typeof a},isFunction:function(a){return"function"==typeof a},isObject:function(a){var b=typeof a;return"function"===b||"object"===b&&!!a},equalTag:function(a,b){try{return a.tagName.toLowerCase()===b.toString()}catch(c){return!1}},format:function(a){if(arguments.length<=1||this.isUndefined(a))return!1;for(var b=a,c=1,d=arguments.length;d>c;c++){var e="%s"+c.toString();b=b.replace(e,encodeURIComponent(arguments[c]))}return b},findParentElement:function(a,b){if(this.isUndefined(a)||this.isEmpty(b))throw"params are required";for(var c=this.equalTag(a,b),d=!1,e=5,f=0;!c&&!d;)a=a.parentNode,c=this.equalTag(a,b),f++,d=f===e?!0:!1;return d?!1:a},getRow:function(a){if(this.isUndefined(a))throw"el is undefined";if(!this.isElement(a))throw"is not a valid DOM Element";return this.findParentElement(a,"tr")},getCol:function(a,b){if(this.isUndefined(a)||!this.isElement(a))throw"empty or invalid element";return this.equalTag(a,"tr")?a.cells[parseInt(b,10)]:this.findParentElement(a,"td")},getColValue:function(a,b){if(this.isUndefined(a))throw"element is required";this.isEmpty(b)&&(b=0);var c=this.getCol(a,b);return c.hasChildNodes()&&this.equalTag(c.childNodes[0],"input")?c.childNodes[0].value:c.innerHTML}},c=function(){this.options=b.extend({},a,arguments[0]),b.equalTag(this.options.table,"table")&&(this.options.table=this.options.table.tBodies[0]),this.init()};return c.prototype.init=function(){this.options.btn&&(this.options.btn.onclick=this.onClickSave.bind(this)),this.options.saveOrder&&(this.options.saveOrder.onclick=this.onClickSaveOrder.bind(this)),this.options.checkTitle&&(this.options.checkTitle.onclick=this.onClickCheckBox.bind(this));var a=this.options.table.rows.length;if(this.options.empty=0===a,this.options.nextId=a+1,this.options.empty)this._addEmptyRow();else for(var c=0,d=a;d>c;c++){var e=b.getCol(this.options.table.rows[c],3);e.firstChild.onclick=this.onClickEdit.bind(this);var f=b.getCol(this.options.table.rows[c],4);f.firstChild.onclick=this.onClickDelete.bind(this)}},c.prototype._addEmptyRow=function(){var a=this.options.table.insertRow(-1);a.className="kv-empty";var b=a.insertCell(0);b.innerHTML=this.options.emptyText,b.colSpan="5"},c.prototype._setId=function(){var a=b.format(this.options.formatId,this.options.nextId);return this.options.nextId+=1,a},c.prototype._edited=function(){return arguments.length&&!b.isUndefined(arguments[0])&&(this.options.edit.editing=Boolean(arguments[0])),this.options.edit.editing},c.prototype._editDelete=function(){return arguments.length&&!b.isUndefined(arguments[0])&&(this.options.edit.deleted=Boolean(arguments[0])),this.options.edit.deleted},c.prototype._rowEditing=function(){return arguments.length&&!b.isUndefined(arguments[0])&&(this.options.edit.row=arguments[0]),this.options.edit.row},c.prototype._editingValue=function(a,c){return this.options.edit.hasOwnProperty(a)?(b.isUndefined(c)||(this.options.edit[a]=c.toString()),this.options.edit[a]):!1},c.prototype._createCheckBox=function(){var a=document.createElement("input");return a.type="checkbox",a.className="multiselect",a.name=this.options.inputs.name+this.options.inputs.checkboxName,a},c.prototype._createEditBtn=function(){var a=document.createElement("a");return a.className="kv-edit",a.onclick=this.onClickEdit.bind(this),a.innerHTML='<img src="'+this.options.icons.editIcon+'" alt="Edit">',a.href="#",a},c.prototype._createCancelEditBtn=function(){var a=document.createElement("a");return a.className="kv-cancel",a.onclick=this.onClickCancelEdit.bind(this),a.innerHTML='<img src="'+this.options.icons.cancelIcon+'" alt="Cancel">',a.href="#",a},c.prototype._createSaveBtn=function(){var a=document.createElement("a");return a.className="kv-save",a.onclick=this.onSaveRow.bind(this),a.innerHTML='<img src="'+this.options.icons.saveIcon+'" alt="Save">',a.href="#",a},c.prototype._createDeleteBtn=function(){var a=document.createElement("a");return a.className="kv-delete",a.onclick=this.onClickDelete.bind(this),a.innerHTML='<img src="'+this.options.icons.deleteIcon+'" alt="Delete">',a.href="#",a},c.prototype._createInput=function(a,c){var d=document.createElement("input");return d.type="text",d.value=c,d.className="kv-input",b.insert(a,d),d},c.prototype._createInlineEdit=function(){var a=this._rowEditing(),c=b.getCol(a,0),d=b.getCol(a,1),e=b.getColValue(c),f=b.getColValue(d);this._editingValue("beforeInput1",e),this._editingValue("beforeInput2",f),this._createInput(c,e),this._createInput(d,f)},c.prototype._restoreInlineEdit=function(){b.insert(b.getCol(this._rowEditing(),3),this._createEditBtn()),this._rowEditing(null),this._editingValue("beforeInput1",""),this._editingValue("beforeInput2",""),this._edited(!1)},c.prototype._rollbackInlineEdit=function(){var a=this._rowEditing(),c=b.getCol(a,0),d=b.getCol(a,1),e=this._editingValue("beforeInput1"),f=this._editingValue("beforeInput2");b.insert(c,e),b.insert(d,f),this._restoreInlineEdit()},c.prototype._updateRow=function(){var a=this._rowEditing(),c=b.getCol(a,0),d=b.getCol(a,1),e=a.dataset.id,f=b.getColValue(c),g=b.getColValue(d),h=b.format(this.options.formatText,e,f,g),i=b.format(this.options.formatText,e,this._editingValue("beforeInput1"),this._editingValue("beforeInput2"));return this.options.hiddenInput.value=this.options.hiddenInput.value.replace(i,h),b.insert(c,f),b.insert(d,g),!0},c.prototype.getRowValue=function(a){if(b.isUndefined(a))throw"row is undefined";return b.format(this.options.formatText,a.dataset.id,b.getColValue(a,0),b.getColValue(a,1))},c.prototype.isEmptyFields=function(){return""===this.options.inputLabel.value||""===this.options.inputValue.value},c.prototype.updateHidden=function(){var a=!1,c="";1===arguments.length?c=arguments[0]:2===arguments.length?b.isBoolean(arguments[1])?(c=arguments[0],a=arguments[1]):c=b.format(this.options.formatText,arguments[0],arguments[1]):(c=b.format(this.options.formatText,arguments[0],arguments[1],arguments[2]),arguments.hasOwnProperty(3)&&(a=Boolean(arguments[3])));var d=b.getValue(this.options.hiddenInput),e=d;if(a){var f=new RegExp(c+"[;]?|[;]?"+c);e=d.replace(f,"")}else e=d,b.isEmpty(d)?e=c:e+=this.options.separator+c;b.setValue(this.options.hiddenInput,e)},c.prototype.clearFields=function(){this.options.inputLabel.value="",this.options.inputValue.value=""},c.prototype.onClickSave=function(a){a.preventDefault(),this.isEmptyFields()||(this._edited()&&this._rollbackInlineEdit(),this.addRow()||alert("Error adding a Row"),this.clearFields())},c.prototype.onClickEdit=function(a){if(a.preventDefault(),!this._edited()){this._edited(!0),this._rowEditing(b.getRow(a.target)),this._createInlineEdit();var c=b.getCol(a.target);b.insert(c,this._createSaveBtn()),c.appendChild(this._createCancelEditBtn())}},c.prototype.onSaveRow=function(a){if(a.preventDefault(),this._edited()){try{this._updateRow()}catch(b){this._rollbackInlineEdit(),alert("Error when update values")}this._restoreInlineEdit()}},c.prototype.onClickDelete=function(a){a.preventDefault();var c=b.getRow(a.target);this.removeRow(c)},c.prototype.onClickCancelEdit=function(a){a.preventDefault(),this._rollbackInlineEdit()},c.prototype.onClickSaveOrder=function(a){a.preventDefault();for(var c="",d=0,e=this.options.table.rows.length;e>d;d++)c+=this.getRowValue(this.options.table.rows[d]),c+=e-d>1?";":"";b.setValue(this.options.hiddenInput,c)},c.prototype.onClickCheckBox=function(a){var b=a.currentTarget.checked;this.options.inputValue.value=b?"TITLE":"",this.options.inputValue.disabled=b},c.prototype.addCell=function(a,c,d){var e=a.insertCell(c);return e.className="kv-col"+c.toString(),b.isFunction(d)?b.insert(e,d.apply(this)):b.insert(e,d),e},c.prototype.addRow=function(){try{this.options.empty&&(this.options.table.deleteRow(-1),this.options.empty=!1);var a=b.getValue(this.options.inputLabel),c=b.getValue(this.options.inputValue),d=this.options.table.insertRow(-1);d.className=this.options.rowClass[this.options.rowClass.actual],this.options.rowClass.actual="odd"===this.options.rowClass.actual?"even":"odd";var e=this._setId();d.dataset.id=e,this.addCell(d,0,a),this.addCell(d,1,c),this.addCell(d,2,this._createCheckBox),this.addCell(d,3,this._createEditBtn),this.addCell(d,4,this._createDeleteBtn),this.updateHidden(e,a,c)}catch(f){return!1}return!0},c.prototype.removeRow=function(a){try{var b=this.getRowValue(a);this.options.table.deleteRow(a.rowIndex-1),this.updateHidden(b,!0),0===this.options.table.rows.length&&(this.options.empty=!0,this.options.nextId=1,this._addEmptyRow())}catch(c){return!1}return!0},c}();