/*! jquery.tablednd.js 11-12-2014 */
!function(e,t,a,n){var i="ontouchstart"in a.documentElement,r=i?"touchstart":"mousedown",l=i?"touchmove":"mousemove",s=i?"touchend":"mouseup";i&&e.each("touchstart touchmove touchend".split(" "),function(t,a){e.event.fixHooks[a]=e.event.mouseHooks}),e(a).ready(function(){function t(e){for(var t={},a=e.match(/([^;:]+)/g)||[];a.length;)t[a.shift()]=a.shift().trim();return t}e("table").each(function(){"dnd"==e(this).data("table")&&e(this).tableDnD({onDragStyle:e(this).data("ondragstyle")&&t(e(this).data("ondragstyle"))||null,onDropStyle:e(this).data("ondropstyle")&&t(e(this).data("ondropstyle"))||null,onDragClass:e(this).data("ondragclass")==n&&"tDnD_whileDrag"||e(this).data("ondragclass"),onDrop:e(this).data("ondrop")&&new Function("table","row",e(this).data("ondrop")),onDragStart:e(this).data("ondragstart")&&new Function("table","row",e(this).data("ondragstart")),scrollAmount:e(this).data("scrollamount")||5,sensitivity:e(this).data("sensitivity")||10,hierarchyLevel:e(this).data("hierarchylevel")||0,indentArtifact:e(this).data("indentartifact")||'<div class="indent">&nbsp;</div>',autoWidthAdjust:e(this).data("autowidthadjust")||!0,autoCleanRelations:e(this).data("autocleanrelations")||!0,jsonPretifySeparator:e(this).data("jsonpretifyseparator")||"   ",serializeRegexp:e(this).data("serializeregexp")&&new RegExp(e(this).data("serializeregexp"))||/[^\-]*$/,serializeParamName:e(this).data("serializeparamname")||!1,dragHandle:e(this).data("draghandle")||null})})}),jQuery.tableDnD={currentTable:null,dragObject:null,mouseOffset:null,oldX:0,oldY:0,build:function(t){return this.each(function(){this.tableDnDConfig=e.extend({onDragStyle:null,onDropStyle:null,onDragClass:"tDnD_whileDrag",onDrop:null,onDragStart:null,scrollAmount:5,sensitivity:10,hierarchyLevel:0,indentArtifact:'<div class="indent">&nbsp;</div>',autoWidthAdjust:!0,autoCleanRelations:!0,jsonPretifySeparator:"    ",serializeRegexp:/[^\-]*$/,serializeParamName:!1,dragHandle:null},t||{}),e.tableDnD.makeDraggable(this),this.tableDnDConfig.hierarchyLevel&&e.tableDnD.makeIndented(this)}),this},makeIndented:function(t){var a,n,i=t.tableDnDConfig,r=t.rows,l=e(r).first().find("td:first")[0],s=0,o=0;if(e(t).hasClass("indtd"))return null;n=e(t).addClass("indtd").attr("style"),e(t).css({whiteSpace:"nowrap"});for(var d=0;d<r.length;d++)o<e(r[d]).find("td:first").text().length&&(o=e(r[d]).find("td:first").text().length,a=d);for(e(l).css({width:"auto"}),d=0;d<i.hierarchyLevel;d++)e(r[a]).find("td:first").prepend(i.indentArtifact);for(l&&e(l).css({width:l.offsetWidth}),n&&e(t).css(n),d=0;d<i.hierarchyLevel;d++)e(r[a]).find("td:first").children(":first").remove();return i.hierarchyLevel&&e(r).each(function(){s=e(this).data("level")||0,s<=i.hierarchyLevel&&e(this).data("level",s)||e(this).data("level",0);for(var t=0;t<e(this).data("level");t++)e(this).find("td:first").prepend(i.indentArtifact)}),this},makeDraggable:function(t){var a=t.tableDnDConfig;a.dragHandle&&e(a.dragHandle,t).each(function(){e(this).bind(r,function(n){return e.tableDnD.initialiseDrag(e(this).parents("tr")[0],t,this,n,a),!1})})||e(t.rows).each(function(){e(this).hasClass("nodrag")||e(this).bind(r,function(n){return"TD"==n.target.tagName?(e.tableDnD.initialiseDrag(this,t,this,n,a),!1):void 0}).css("cursor","move")})},currentOrder:function(){var t=this.currentTable.rows;return e.map(t,function(t){return(e(t).data("level")+t.id).replace(/\s/g,"")}).join("")},initialiseDrag:function(t,n,i,r,o){this.dragObject=t,this.currentTable=n,this.mouseOffset=this.getMouseOffset(i,r),this.originalOrder=this.currentOrder(),e(a).bind(l,this.mousemove).bind(s,this.mouseup),o.onDragStart&&o.onDragStart(n,i)},updateTables:function(){this.each(function(){this.tableDnDConfig&&e.tableDnD.makeDraggable(this)})},mouseCoords:function(e){return i?{x:event.changedTouches[0].clientX,y:event.changedTouches[0].clientY}:e.pageX||e.pageY?{x:e.pageX,y:e.pageY}:{x:e.clientX+a.body.scrollLeft-a.body.clientLeft,y:e.clientY+a.body.scrollTop-a.body.clientTop}},getMouseOffset:function(e,a){var n,i;return a=a||t.event,i=this.getPosition(e),n=this.mouseCoords(a),{x:n.x-i.x,y:n.y-i.y}},getPosition:function(e){var t=0,a=0;for(0==e.offsetHeight&&(e=e.firstChild);e.offsetParent;)t+=e.offsetLeft,a+=e.offsetTop,e=e.offsetParent;return t+=e.offsetLeft,a+=e.offsetTop,{x:t,y:a}},autoScroll:function(e){var n=this.currentTable.tableDnDConfig,i=t.pageYOffset,r=t.innerHeight?t.innerHeight:a.documentElement.clientHeight?a.documentElement.clientHeight:a.body.clientHeight;a.all&&("undefined"!=typeof a.compatMode&&"BackCompat"!=a.compatMode?i=a.documentElement.scrollTop:"undefined"!=typeof a.body&&(i=a.body.scrollTop)),e.y-i<n.scrollAmount&&t.scrollBy(0,-n.scrollAmount)||r-(e.y-i)<n.scrollAmount&&t.scrollBy(0,n.scrollAmount)},moveVerticle:function(e,t){0!=e.vertical&&t&&this.dragObject!=t&&this.dragObject.parentNode==t.parentNode&&(0>e.vertical&&this.dragObject.parentNode.insertBefore(this.dragObject,t.nextSibling)||0<e.vertical&&this.dragObject.parentNode.insertBefore(this.dragObject,t))},moveHorizontal:function(t,a){var n,i=this.currentTable.tableDnDConfig;return i.hierarchyLevel&&0!=t.horizontal&&a&&this.dragObject==a?(n=e(a).data("level"),0<t.horizontal&&n>0&&e(a).find("td:first").children(":first").remove()&&e(a).data("level",--n),void(0>t.horizontal&&n<i.hierarchyLevel&&e(a).prev().data("level")>=n&&e(a).children(":first").prepend(i.indentArtifact)&&e(a).data("level",++n))):null},mousemove:function(t){var a,n,i,r,l,s=e(e.tableDnD.dragObject),o=e.tableDnD.currentTable.tableDnDConfig;return t&&t.preventDefault(),e.tableDnD.dragObject?("touchmove"==t.type&&event.preventDefault(),o.onDragClass&&s.addClass(o.onDragClass)||s.css(o.onDragStyle),n=e.tableDnD.mouseCoords(t),r=n.x-e.tableDnD.mouseOffset.x,l=n.y-e.tableDnD.mouseOffset.y,e.tableDnD.autoScroll(n),a=e.tableDnD.findDropTargetRow(s,l),i=e.tableDnD.findDragDirection(r,l),e.tableDnD.moveVerticle(i,a),e.tableDnD.moveHorizontal(i,a),!1):!1},findDragDirection:function(e,t){var a=this.currentTable.tableDnDConfig.sensitivity,n=this.oldX,i=this.oldY,r=n-a,l=n+a,s=i-a,o=i+a,d={horizontal:e>=r&&l>=e?0:e>n?-1:1,vertical:t>=s&&o>=t?0:t>i?-1:1};return 0!=d.horizontal&&(this.oldX=e),0!=d.vertical&&(this.oldY=t),d},findDropTargetRow:function(t,a){for(var n=0,i=this.currentTable.rows,r=this.currentTable.tableDnDConfig,l=0,s=null,o=0;o<i.length;o++)if(s=i[o],l=this.getPosition(s).y,n=parseInt(s.offsetHeight)/2,0==s.offsetHeight&&(l=this.getPosition(s.firstChild).y,n=parseInt(s.firstChild.offsetHeight)/2),a>l-n&&l+n>a)return t.is(s)||r.onAllowDrop&&!r.onAllowDrop(t,s)||e(s).hasClass("nodrop")?null:s;return null},processMouseup:function(){var t=this.dragObject,n=0,i=0;if(!this.currentTable||!t)return null;var r=this.currentTable.tableDnDConfig;e(a).unbind(l,this.mousemove).unbind(s,this.mouseup),r.hierarchyLevel&&r.autoCleanRelations&&e(this.currentTable.rows).first().find("td:first").children().each(function(){i=e(this).parents("tr:first").data("level"),i&&e(this).parents("tr:first").data("level",--i)&&e(this).remove()})&&r.hierarchyLevel>1&&e(this.currentTable.rows).each(function(){if(i=e(this).data("level"),i>1)for(n=e(this).prev().data("level");i>n+1;)e(this).find("td:first").children(":first").remove(),e(this).data("level",--i)}),r.onDragClass&&e(t).removeClass(r.onDragClass)||e(t).css(r.onDropStyle),this.dragObject=null,r.onDrop&&this.originalOrder!=this.currentOrder()&&e(t).hide().fadeIn("fast")&&r.onDrop(this.currentTable,t),this.currentTable=null},mouseup:function(t){return t&&t.preventDefault(),e.tableDnD.processMouseup(),!1},jsonize:function(e){var t=this.currentTable;return e?JSON.stringify(this.tableData(t),null,t.tableDnDConfig.jsonPretifySeparator):JSON.stringify(this.tableData(t))},serialize:function(){return e.param(this.tableData(this.currentTable))},serializeTable:function(e){for(var t="",a=e.tableDnDConfig.serializeParamName||e.id,n=e.rows,i=0;i<n.length;i++){t.length>0&&(t+="&");var r=n[i].id;r&&e.tableDnDConfig&&e.tableDnDConfig.serializeRegexp&&(r=r.match(e.tableDnDConfig.serializeRegexp)[0],t+=a+"[]="+r)}return t},serializeTables:function(){var t=[];return e("table").each(function(){this.id&&t.push(e.param(this.tableData(this)))}),t.join("&")},tableData:function(t){var a,n,i,r,l=t.tableDnDConfig,s=[],o=0,d=0,h=null,u={};if(t||(t=this.currentTable),!(t&&t.id&&t.rows&&t.rows.length))return{error:{code:500,message:"Not a valid table, no serializable unique id provided."}};r=l.autoCleanRelations&&t.rows||e.makeArray(t.rows),n=l.serializeParamName||t.id,i=n,a=function(e){return e&&l&&l.serializeRegexp?e.match(l.serializeRegexp)[0]:e},u[i]=[],!l.autoCleanRelations&&e(r[0]).data("level")&&r.unshift({id:"undefined"});for(var c=0;c<r.length;c++)if(l.hierarchyLevel){if(d=e(r[c]).data("level")||0,0==d)i=n,s=[];else if(d>o)s.push([i,o]),i=a(r[c-1].id);else if(o>d)for(var f=0;f<s.length;f++)s[f][1]==d&&(i=s[f][0]),s[f][1]>=o&&(s[f][1]=0);o=d,e.isArray(u[i])||(u[i]=[]),h=a(r[c].id),h&&u[i].push(h)}else h=a(r[c].id),h&&u[i].push(h);return u}},jQuery.fn.extend({tableDnD:e.tableDnD.build,tableDnDUpdate:e.tableDnD.updateTables,tableDnDSerialize:e.proxy(e.tableDnD.serialize,e.tableDnD),tableDnDSerializeAll:e.tableDnD.serializeTables,tableDnDData:e.proxy(e.tableDnD.tableData,e.tableDnD)})}(jQuery,window,window.document);